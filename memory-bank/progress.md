# progress.md

## 已完成/運作中

- 核心戰鬥循環（召喚、攻擊、技能使用、回合制邏輯）。
- 敵人 AI 基本行為模式。
- 基本單位屬性與統計。
- 戰鬥 UI 框架（顯示單位資訊、技能按鈕）。
- 經驗值與金幣獎勵計算。
- 物品掉落機制基礎（從敵人模板讀取掉落表）。
- CSV 數據導入（敵人、物品、技能）。
- 事件管理器系統。
- 基本粒子效果。
- Tilemap 地形交互基礎。
- 飛行道具創建流程（怪物掉落 + 採集）。
- 飛行道具的 `SCATTERING` 和 `WAIT_ON_GROUND` 狀態基礎物理模擬（使用 Tilemap 檢測地面）。
- **已解決**：飛行道具創建和 Step 事件中的 `string_format` 除錯函數錯誤。

## 待辦/已知問題

- **核心問題**：`obj_flying_item` 無法正確飛向玩家，且在非 `SCATTERING` 狀態下 `vspeed` 異常增加，懷疑受父物件 Step 事件影響。 （**當前調查中**）
- **視覺效果**：怪物掉落噴射效果可能需要調整初速度以獲得更明顯的「爆開」感。
- **功能待完善**：
    - 玩家等級與屬性成長系統。
    - 更豐富的技能類型與效果（狀態異常、Buff/Debuff、範圍效果）。
    - 捕獲怪物機制實現。
    - 物品系統完善（使用、裝備？）。
    - 完整的遊戲流程（地圖移動、觸發戰鬥等）。
    - UI/UX 細節打磨（動畫、反饋）。
- **潛在風險**：
    - 隨著系統複雜度增加，狀態管理和事件交互可能變得困難。
    - 性能優化（尤其是在大量單位或粒子效果時）。

## 未來規劃

- 加入更多敵人種類與技能。
- 設計不同的遊戲區域和關卡。
- 開發劇情或任務系統。
- 建立存檔/讀檔系統。
- 優化使用者介面與體驗。

## 已知問題
- 採集系統掉落尚未工廠化，維護需多處同步
- 飛行道具與 GUI 座標轉換耦合仍有殘留
- 掉落工廠尚未設計，日後需統一管理

## What works

- 核心移動與八方向動畫系統
- 事件系統基本框架 (`obj_event_manager`)
- 戰鬥系統基礎狀態機 (`obj_battle_manager`)
- 敵人系統工廠化 (`obj_enemy_factory` 從 CSV 載入)
- 經驗與升級系統 (基於 CSV, `obj_level_manager`, 單位 `level_up` 邏輯)
- 戰鬥結果事件流 (`finalize_battle_results` 等) 與獎勵計算 (金幣, 掉落物)
- 單位基礎 (`obj_battle_unit_parent`), 包括非戰鬥遊蕩、受傷特效、浮動文字
- 物品系統 (`obj_item_manager` 從 CSV 載入, 背包操作)
- 基礎 UI (HUD, 物品欄, 彈窗, 快捷欄數據與基礎交互)
- 採集系統 (`obj_stone` 挖掘邏輯)
- **飛行道具 (`obj_flying_item`)**: 
    - 狀態機 (`FLYING_UP`, `PAUSING`, `FLYING_TO_PLAYER`, `FADING_OUT`) 基本正常。
    - **`SCATTERING` 狀態**: 已重構為使用 Z 軸物理模擬，實現拋物線、落地、反彈效果。
    - **渲染**: 外框 (`bm_add`) 和數量文字 (跟隨 Z 軸，大小可調) 顯示正常。
    - **狀態**: 等待時 (`WAIT_ON_GROUND`) 不再垂直漂移。
    - **參數**: 水平散開範圍已調整。
- 冗餘代碼清理：移除了 `obj_battle_manager` 中衝突的 `Alarm 0` 和 `scr_coordinate_utils` 中無用的 `world_to_gui_coords`。

## What's left to build

- **完善快捷欄**: 快捷欄物品使用、與其他 UI (如製作) 的交互。
- **戰鬥結果 UI**: 確認是否正確顯示所有掉落物品；實現更完善的結果展示流程 (等待動畫等)。
- **新增**: **根據物品稀有度改變飛行道具 (`obj_flying_item`) 的外框顏色。**
- **Battle Log**: 實現 UI 面板和詳細日誌記錄。
- **深化戰鬥**: 更多技能、狀態、AI、行動順序機制。
- **豐富物品**: 更多消耗品、裝備、材料。
- **捕捉與養成**: 細化捕捉、技能學習/遺忘、進化等。

## Known Issues

- 飛行道具 (`obj_flying_item`) 在 `FLYING_TO_PLAYER` 狀態下直接使用 `Player.x`, `Player.y` 作為目標，可能在鏡頭快速移動時產生視覺追趕延遲（待觀察）。
- 採集系統掉落尚未工廠化，維護需多處同步
- 掉落工廠尚未設計，日後需統一管理 