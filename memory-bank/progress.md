# progress.md

## 已完成/運作中

- **戰鬥結果 UI (`obj_battle_ui`) 事件接收與基礎顯示：**
    - 已修復事件回調機制，`show_rewards` 方法現在能正確被 `show_battle_result` 事件觸發。
    - UI 能接收事件數據並執行顯示邏輯，解決了先前卡住的問題。
- 核心戰鬥循環（召喚、攻擊、技能使用、回合制邏輯）。
- 敵人 AI 基本行為模式。
- 基本單位屬性與統計。
- 戰鬥 UI 框架（顯示單位資訊、技能按鈕）。
- 經驗值與金幣獎勵計算。
- 物品掉落機制基礎（從敵人模板讀取掉落表）。
- CSV 數據導入（敵人、物品、技能）。
- 事件管理器系統。
- 基本粒子效果。
- Tilemap 地形交互基礎。
- 飛行道具創建流程（怪物掉落 + 採集）。
- 飛行道具的 `SCATTERING` 和 `WAIT_ON_GROUND` 狀態基礎物理模擬（使用 Tilemap 檢測地面）。
- **已解決**：飛行道具創建和 Step 事件中的 `string_format` 除錯函數錯誤。
- **已解決**：**事件管理器 `trigger_event` 功能實現：** 在 `obj_event_manager` 中添加了標準的 `trigger_event` 函數，解決了獎勵系統等處觸發事件的警告。
- **已解決**：**重複隱藏 UI 警告修復：** 移除了 `obj_battle_ui` 中 `handle_close_input` 的直接隱藏請求，統一由 `obj_ui_manager` 響應 `battle_end` 事件關閉 UI，解決了重複隱藏警告。
- 技能系統重構進度：尚未完成，目前仍有大量 struct/array 型別錯誤與 bug，尚未達到 array 索引一一對應的目標。主要卡點：技能冷卻初始化、技能新增、技能查找等流程型別不一致，導致崩潰。每次 build 幾乎都會遇到技能冷卻相關錯誤，需持續修正。


## 待辦/已知問題

- **核心問題 - 高優先級:**
    - **事件管理器缺少 `trigger_event` 功能**: 在獎勵系統等處觀察到警告，影響系統間通信。(**當前調查中**)
- **核心問題 - 中優先級:**
    - **戰鬥狀態警告**: 初始化戰鬥時提示 `戰鬥已經在進行中`。
- **功能待完善:**
    - 戰鬥結果 UI 的關閉邏輯需要從 `obj_battle_manager` 遷移到 UI 層。
    - 恢復玩家移動能力。
    - 玩家等級與屬性成長系統。
    - 更豐富的技能類型與效果（狀態異常、Buff/Debuff、範圍效果）。
    - 捕獲怪物機制實現。
    - 物品系統完善（使用、裝備？）。
    - 完整的遊戲流程（地圖移動、觸發戰鬥等）。
    - UI/UX 細節打磨（動畫、反饋）。
- **低優先級問題:**
    - 資源缺失警告 (`spr_...`)。
    - 技能管理器缺少 `on_game_save`/`on_game_load` 回調。
    - `add_battle_log` 缺少 `max_log_lines` 定義。
    - `on_battle_start` 數據缺少 `initial_enemy`。
    - UI 管理器日誌過於頻繁。
- **潛在風險**：
    - 隨著系統複雜度增加，狀態管理和事件交互可能變得困難。
    - 性能優化（尤其是在大量單位或粒子效果時）。

## 未來規劃

- 加入更多敵人種類與技能。
- 設計不同的遊戲區域和關卡。
- 開發劇情或任務系統。
- 建立存檔/讀檔系統。
- 優化使用者介面與體驗。

## 已知問題
- 採集系統掉落尚未工廠化，維護需多處同步
- 飛行道具與 GUI 座標轉換耦合仍有殘留
- 掉落工廠尚未設計，日後需統一管理

## What works

- 核心移動與八方向動畫系統
- 事件系統基本框架 (`obj_event_manager`)
- 戰鬥系統基礎狀態機 (`obj_battle_manager`)
- 敵人系統工廠化 (`obj_enemy_factory` 從 CSV 載入)
- 經驗與升級系統 (基於 CSV, `obj_level_manager`, 單位 `level_up` 邏輯)
- 戰鬥結果事件流 (`finalize_battle_results` 等) 與獎勵計算 (金幣, 掉落物)
- 單位基礎 (`obj_battle_unit_parent`), 包括非戰鬥遊蕩、受傷特效、浮動文字
- 物品系統 (`obj_item_manager` 從 CSV 載入, 背包操作)
- 基礎 UI (HUD, 物品欄, 彈窗, 快捷欄數據與基礎交互)
- 採集系統 (`obj_stone` 挖掘邏輯)
- **飛行道具 (`obj_flying_item`)**: 
    - 狀態機 (`FLYING_UP`, `PAUSING`, `FLYING_TO_PLAYER`, `FADING_OUT`) 基本正常。
    - **`SCATTERING` 狀態**: 已重構為使用 Z 軸物理模擬，實現拋物線、落地、反彈效果。
    - **渲染**: 外框 (`bm_add`) 和數量文字 (跟隨 Z 軸，大小可調) 顯示正常。
    - **狀態**: 等待時 (`WAIT_ON_GROUND`) 不再垂直漂移。
    - **參數**: 水平散開範圍已調整。
- 冗餘代碼清理：移除了 `obj_battle_manager` 中衝突的 `Alarm 0` 和 `scr_coordinate_utils` 中無用的 `world_to_gui_coords`。

## What's left to build

- **核心功能修復**: 實現或修復 `obj_event_manager` 的 `trigger_event` 功能。
- **邏輯遷移**: 將戰鬥結果關閉邏輯移至 UI 層。
- **功能恢復**: 恢復玩家移動。
- **完善快捷欄**: 快捷欄物品使用、與其他 UI (如製作) 的交互。
- **戰鬥結果 UI**: 確認是否正確顯示所有掉落物品；實現更完善的結果展示流程 (等待動畫等)。
- **新增**: **根據物品稀有度改變飛行道具 (`obj_flying_item`) 的外框顏色。**
- **Battle Log**: 實現 UI 面板和詳細日誌記錄。
- **深化戰鬥**: 更多技能、狀態、AI、行動順序機制。
- **豐富物品**: 更多消耗品、裝備、材料。
- **捕捉與養成**: 細化捕捉、技能學習/遺忘、進化等。

## Known Issues

- **(已解決)** 事件管理器 `trigger_event` 功能缺失或調用錯誤。
- **(已解決)** 重複隱藏 UI 的警告。
- 戰鬥狀態初始化警告。
- 飛行道具 (`obj_flying_item`) 在 `FLYING_TO_PLAYER` 狀態下直接使用 `Player.x`, `Player.y` 作為目標，可能在鏡頭快速移動時產生視覺追趕延遲（待觀察）。
- 採集系統掉落尚未工廠化，維護需多處同步
- 掉落工廠尚未設計，日後需統一管理

## 已完成事項
- [x] 戰鬥事件 callback function 完全重構，移除 obj_battle_manager Create 事件內所有 callback function，統一集中於 battle_callbacks.gml。
- [x] Method Bindings 綁定順序修正，確保 battle_callbacks() 執行後再進行事件註冊。
- [x] 測試所有戰鬥事件流程、掉落、經驗、UI 顯示，皆正常無誤。
- [x] 戰鬥結束流程優化，延遲顯示結果，並修正掉落物動畫與狀態切換。
- [x] 掉落工廠化（怪物），採集掉落工廠化規劃中。
- [x] 飛行道具圖層與座標系統優化。

## 進行中事項
- 採集系統掉落工廠化設計與實作
- 掉落工廠統一化（怪物/採集/礦石）
- 飛行道具與 GUI 座標轉換耦合解耦
- UI/UX 優化與戰鬥結果流程完善

## 待辦事項
- 採集掉落工廠化
- 掉落工廠統一化
- world_to_gui_coords 相關耦合移除
- 戰鬥結果關閉邏輯優化
- 其他系統重構與優化
- 技能系統重構進度：尚未完成，目前仍有大量 struct/array 型別錯誤與 bug，尚未達到 array 索引一一對應的目標。主要卡點：技能冷卻初始化、技能新增、技能查找等流程型別不一致，導致崩潰。每次 build 幾乎都會遇到技能冷卻相關錯誤，需持續修正。 